<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>Virtual Reality Course</title>
		<!-- Landscape shaders -->
		<script id="landscape-vertex-shader" type="notjs">
			attribute vec3 a_position;
			attribute vec3 a_normal;
			attribute vec2 a_uv;

			uniform mat4 u_MVP;
			uniform mat4 u_MV;

			varying vec4 v_position;
			varying vec3 v_normal;
			varying vec2 v_uv;

			void main() {
				v_uv = a_uv;
				v_normal = a_normal;
				v_position = u_MV * vec4(a_position, 1);

				gl_Position = u_MVP * vec4(a_position, 1);
			}
		</script>
		<script id="landscape-fragment-shader" type="notjs">
			precision mediump float;

			uniform sampler2D u_landscape;
			uniform vec3 u_lightPos;

			varying vec4 v_position;
			varying vec3 v_normal;
			varying vec2 v_uv;

			void main() {
			  vec3 lightToPos = normalize(u_lightPos - v_position.xyz);

			  vec4 color = texture2D(u_landscape, v_uv);

			  float ambientStrength = 0.3;
			  vec3 lightColor = vec3(1.0, 1.0, 1.0);
			  vec3 ambient = ambientStrength * lightColor;
			  float diff = max(dot(v_normal, lightToPos), 0.0);
			  gl_FragColor = color * vec4(ambient, 1.0) + color * diff;
			}
		</script>

		<!-- Sky shaders -->
		<script id="sky-vertex-shader" type="notjs">
			attribute vec3 a_position;

			uniform mat4 u_MVP;

			varying vec3 v_texCoord;

			void main() {
			  v_texCoord = vec3(-a_position.x, a_position.y, a_position.z);
			  gl_Position = u_MVP * vec4(a_position, 1);
			}
		</script>
		<script id="sky-fragment-shader" type="notjs">
			precision mediump float;

			uniform samplerCube u_skybox;

			varying vec3 v_texCoord;

			void main() {
			  gl_FragColor = textureCube(u_skybox, v_texCoord);
			}
		</script>

		<!-- Scene object shaders -->
		<script id="object-vertex-shader" type="notjs">
			attribute vec3 a_position;
			attribute vec2 a_uv;

			uniform mat4 u_MP;

			varying vec2 v_uv;

			void main() {
				v_uv = a_uv;
				gl_Position = u_MP * vec4(a_position, 1);
			}
		</script>
		<script id="object-fragment-shader" type="notjs">
			precision mediump float;

			uniform sampler2D u_texture;

			// for fake drowing
			uniform vec3 fake_color;
			uniform int is_fake;

			varying vec2 v_uv;

			void main() {
				if (is_fake == 1) {
					gl_FragColor = vec4(fake_color, 1.0);
				}
				else {
					gl_FragColor = texture2D(u_texture, v_uv);
				}
			}
		</script>

		<!-- Scene relief object -->
		<script id="relief-object-vertex-shader" type="notjs">
			attribute vec3 a_position;
			attribute vec3 a_normal;
			attribute vec3 a_tanget;
			attribute vec3 a_bitangent;
			attribute vec2 a_uv;

			uniform mat4 uViewMatrix;
			uniform mat4 uModelMatrix;
			uniform mat4 uProjectionMatrix;
			uniform mat4 uNormalMatrix;

			uniform vec3 lightPos;
			uniform vec3 viewPos;

			varying highp vec2 vTextureCoord;
			varying highp vec3 vFragPos;

			varying highp vec3 vTangentLightPos;
			varying highp vec3 vTangentViewPos;
			varying highp vec3 vTangentFragPos;

			highp mat3 transpose(highp mat3 inMatrix) {
				highp vec3 i0 = inMatrix[0];
				highp vec3 i1 = inMatrix[1];
				highp vec3 i2 = inMatrix[2];

				highp mat3 outMatrix = mat3(
					vec3(i0.x, i1.x, i2.x),
					vec3(i0.y, i1.y, i2.y),
					vec3(i0.z, i1.z, i2.z)
				);

				return outMatrix;
			}

			void main() {
				gl_Position = uProjectionMatrix * uViewMatrix * uModelMatrix * vec4(a_position, 1.0);

				vFragPos = vec3(uModelMatrix * vec4(a_position, 1.0));
				vTextureCoord = a_uv;

				vec3 T = normalize(vec3(uNormalMatrix * vec4(a_tanget, 1.0)));
				vec3 N = normalize(vec3(uNormalMatrix * vec4(a_bitangent, 1.0)));
				vec3 B = normalize(vec3(uNormalMatrix * vec4(a_bitangent, 1.0)));

				mat3 tTBN = transpose(mat3(T, B, N));

				vTangentLightPos = tTBN * lightPos;
				vTangentViewPos  = tTBN * viewPos;
				vTangentFragPos  = tTBN * vFragPos;
			}
		</script>
		<script id="relief-object-fragment-shader" type="notjs">
			varying highp vec3 vFragPos;
			varying highp vec2 vTextureCoord;
			varying highp vec3 vTangentLightPos;
			varying highp vec3 vTangentViewPos;
			varying highp vec3 vTangentFragPos;


			uniform sampler2D uSampler;
			uniform sampler2D uNormals;

			varying mat3 vTBN;

			highp vec3 lightColor = vec3(1, 1, 0.875);

			void main() {
				vec3 normal = texture2D(uNormals, vTextureCoord).rgb;
				normal = normalize(normal * 2.0 - 1.0);

				vec3 texelColor = texture2D(uSampler, vTextureCoord).rgb;
				// ambient
				vec3 ambient = texelColor * 0.1;

				//diffuse
				vec3 lightDir = normalize(vTangentLightPos - vTangentFragPos);
				float diff = max(dot(normal, lightDir), 0.0);
				vec3 diffuse = diff * texelColor;

				//specular
				vec3 viewDir  = normalize(vTangentViewPos - vTangentFragPos);
				vec3 reflectDir = reflect(-lightDir, normal);
				vec3 halfwayDir = normalize(lightDir + viewDir);
				float spec = pow(max(dot(normal, halfwayDir), 0.0), 32.0);
				vec3 specular = vec3(0.2) * spec;

				gl_FragColor = vec4(ambient + diffuse + specular, 1.0);
			}
		</script>
	</head>
	<body id="body">
		<body id="body">
			<canvas id="canvas" tabindex="1"></canvas>
			<canvas hidden id="canvas-handler"></canvas>
			<img hidden id="landscape" src="assets/images/landscape/heightmap.jpg" />
		</body>
		<script type="text/javascript" src="app.js"></script>
	</body>
	<script type="text/javascript" src="app.js"></script>
</html>
