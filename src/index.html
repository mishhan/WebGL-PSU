<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>Virtual Reality Course</title>
		<!-- Landscape shaders -->
		<script id="landscape-vertex-shader" type="notjs">
			attribute vec3 a_position;
			attribute vec3 a_normal;
			attribute vec2 a_uv;

			uniform mat4 u_MVP;
			uniform mat4 u_MV;

			varying vec4 v_position;
			varying vec3 v_normal;
			varying vec2 v_uv;

			void main() {
				v_uv = a_uv;
				v_normal = a_normal;
				v_position = u_MV * vec4(a_position, 1);

				gl_Position = u_MVP * vec4(a_position, 1);
			}
		</script>
		<script id="landscape-fragment-shader" type="notjs">
			precision mediump float;

			uniform sampler2D u_landscape;
			uniform vec3 u_lightPos;

			varying vec4 v_position;
			varying vec3 v_normal;
			varying vec2 v_uv;

			void main() {
			  vec3 lightToPos = normalize(u_lightPos - v_position.xyz);

			  vec4 color = texture2D(u_landscape, v_uv);

			  float ambientStrength = 0.3;
			  vec3 lightColor = vec3(1.0, 1.0, 1.0);
			  vec3 ambient = ambientStrength * lightColor;
			  float diff = max(dot(v_normal, lightToPos), 0.0);
			  gl_FragColor = color * vec4(ambient, 1.0) + color * diff;
			}
		</script>

		<!-- Sky shaders -->
		<script id="sky-vertex-shader" type="notjs">
			attribute vec3 a_position;

			uniform mat4 u_MVP;

			varying vec3 v_texCoord;

			void main() {
			  v_texCoord = vec3(-a_position.x, a_position.y, a_position.z);
			  gl_Position = u_MVP * vec4(a_position, 1);
			}
		</script>
		<script id="sky-fragment-shader" type="notjs">
			precision mediump float;

			uniform samplerCube u_skybox;

			varying vec3 v_texCoord;

			void main() {
			  gl_FragColor = textureCube(u_skybox, v_texCoord);
			}
		</script>

		<!-- Scene object shaders -->
		<script id="object-vertex-shader" type="notjs">
			attribute vec3 a_position;
			attribute vec2 a_uv;

			uniform mat4 u_MP;

			varying vec2 v_uv;

			void main() {
				v_uv = a_uv;
				gl_Position = u_MP * vec4(a_position, 1);
			}
		</script>
		<script id="object-fragment-shader" type="notjs">
			precision mediump float;

			uniform sampler2D u_texture;

			// for fake drowing
			uniform vec3 fake_color;
			uniform int is_fake;

			varying vec2 v_uv;

			void main() {
				if (is_fake == 1) {
					gl_FragColor = vec4(fake_color, 1.0);
				}
				else {
					gl_FragColor = texture2D(u_texture, v_uv);
				}
			}
		</script>

		<!-- Scene relief object -->
		<script id="relief-object-vertex-shader" type="notjs">
			attribute vec3 a_position;
			attribute vec2 a_uv;
			attribute vec3 a_normal;
			attribute vec3 a_tangent;

			uniform mat4 u_MVP;
			uniform mat4 u_MV;
			uniform mat3 u_n;

			varying vec3 v_ray;
			varying vec3 v_eye;
			varying vec2 v_uv;

			mat3 transpose(mat3 inMatrix) {
				vec4 i0 = inMatrix[0];
				vec4 i1 = inMatrix[1];
				vec4 i2 = inMatrix[2];

				mat3 outMatrix = mat3(
					vec3(i0.x, i1.x, i2.x),
					vec3(i0.y, i1.y, i2.y),
					vec3(i0.z, i1.z, i2.z),
				);

				return outMatrix;
			}

			void main() {
				vec4 pos = vec4(a_position, 1.0);
				vec3 binormal = normalize(cross(a_normal, a_tangent));

				vec3 T = (u_MV * vec4(a_tangent, 0)).xyz;
				vec3 N = (u_MV * vec4(a_normal, 0)).xyz;
				vec3 B = cross(N, T);
				mat3 intbn = transpose(mat3(T, B, N));

				vec3 vPos = intbn * (u_MV * pos).xyz;

				v_ray = normalize(intbn * vec3(0, 1, 0) - vPos);
				v_eye = normalize(-vPos);

				v_uv = a_uv;
				gl_Position = u_MVP * pos;
			}
		</script>
		<script id="relief-object-fragment-shader" type="notjs">
			precision mediump float;

			uniform sampler2D u_texture;
			uniform sampler2D u_normalMap;

			varying vec2 v_uv;
			varying vec3 v_ray;
			varying vec3 v_eye;

			vec4 lit(float l, float h, float m) {
				return vec4(1.0, max(l, 0.0), (l > 0.0) ? pow(max(0.0, h), m) : 0.0, 1.0);
			}

			void main() {
				vec4 diffuseColor = texture2D(u_texture, v_uv);
				vec3 normal = texture2D(u_normalMap, v_uv).rgb;
				normal = 2 * normal - vec3(1);
				normal = normalize(normal);
				vec3 ray = normalize(v_ray);
				var3 eye = normalize(v_eye);
				vec3 halfVector = normalize(ray + eye);

				float ambientStrength = 0.3;
			  vec3 lightColor = vec3(1.0, 1.0, 1.0);
			  vec3 ambient = ambientStrength * lightColor;

				vec4 litR = lit(
					dot(normal, v_ray),
					dot(normal, halfVector),
					1
				);

				vec4 outColor = vec4((lightColor * (diffuseColor * litR.y + diffuseColor * 0.3)).rgb, diffuseColor.a);
				gl_FragColor = outColor;
			}
		</script>
	</head>
	<body id="body">
		<body id="body">
			<canvas id="canvas" tabindex="1"></canvas>
			<canvas hidden id="canvas-handler"></canvas>
			<img hidden id="landscape" src="assets/images/landscape/heightmap.jpg" />
		</body>
		<script type="text/javascript" src="app.js"></script>
	</body>
	<script type="text/javascript" src="app.js"></script>
</html>
